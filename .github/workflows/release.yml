name: Release with Test Report

on:
  release:
    types: [created, published]
  workflow_dispatch:  # Allow manual trigger

jobs:
  test-and-report:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.8'
    
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y tesseract-ocr poppler-utils
    
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        python -m spacy download en_core_web_sm
    
    - name: Run tests and generate report
      run: |
        python tests/run_tests.py -v > test_report.txt 2>&1 || true
        
        # Also generate JSON report for programmatic access
        python -m pytest tests/ --tb=short --junit-xml=test_results.xml -v || true
    
    - name: Create test summary
      run: |
        echo "# Test Report - Release ${{ github.event.release.tag_name }}" > test_summary.md
        echo "" >> test_summary.md
        echo "**Date:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> test_summary.md
        echo "**Commit:** ${{ github.sha }}" >> test_summary.md
        echo "" >> test_summary.md
        echo "## Test Results" >> test_summary.md
        echo "\`\`\`" >> test_summary.md
        cat test_report.txt >> test_summary.md
        echo "\`\`\`" >> test_summary.md
    
    - name: Upload test report as artifact
      uses: actions/upload-artifact@v4
      with:
        name: test-report-${{ github.event.release.tag_name }}
        path: |
          test_report.txt
          test_summary.md
          test_results.xml
    
    - name: Attach test report to release
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ github.event.release.upload_url }}
        asset_path: ./test_report.txt
        asset_name: test-report-${{ github.event.release.tag_name }}.txt
        asset_content_type: text/plain
    
    - name: Attach markdown summary to release
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ github.event.release.upload_url }}
        asset_path: ./test_summary.md
        asset_name: test-summary-${{ github.event.release.tag_name }}.md
        asset_content_type: text/markdown
    
    - name: Add test status to release notes
      if: always()
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          const testReport = fs.readFileSync('test_report.txt', 'utf8');
          const lines = testReport.split('\n');
          
          // Extract summary line
          const summaryLine = lines.find(l => l.includes('Tests run:')) || 'Test results not found';
          
          const release = await github.rest.repos.getRelease({
            owner: context.repo.owner,
            repo: context.repo.repo,
            release_id: context.payload.release.id
          });
          
          const newBody = `${release.data.body}\n\n---\n\n## ðŸ§ª Test Report\n\n${summaryLine}\n\nðŸ“„ See attached test reports for details.`;
          
          await github.rest.repos.updateRelease({
            owner: context.repo.owner,
            repo: context.repo.repo,
            release_id: context.payload.release.id,
            body: newBody
          });
